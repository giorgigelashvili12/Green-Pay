# 1. 2FA (Two-Factor Authentication) - Fundamentals
2FA is a security mechanism requiring two different forms of authentication to verify user's identity. Two factors typically include **Something you know,** like a password or a PIN generated by the system, or instead **something that you have**, like device generating codes (TOTP), SMS or hardware tokens. There's also a third factor claimed as **Something you are** which is basically biometrics like fingerprints and facial recognition. This part is both hard and optional. 2FA is important for many reasons, like for strengthening account security with more than just a pasword, protecting against attacks and for risk minimization, even if the primary credential - password is compromised.

# 2. TOTP (Time-Based One-Time Password)
TOTP is a method of generating a temporary, time-sensetive codes based on a shared secret and the current time. The code typically expires every 30 seconds and is used in conjuction with 2FA for further secure authentications. TOTP work flow is somewhat simple: First, a random string (Shared Secret) is generated during the setup and shared securely between the server and the client. Second, the shared secret and current time are used to generate a code using an algorithm and lastly, validation, where server validates the code entered by the user, by regenerating it using the same secret and time widnow.

## 2FA & TOTP Node.js
For Node, use library like `otplib` or `bcrypt` to generate a base32 secret:
### Shared Secret Genertion
```js
const otplib = require('otplib');
const sec = otplib.authenticator.generateSecret();
```
### QR Code for Users
```js
const qrcode = require('qrcode');
const otplib = require('otplib');

const sec = otplib.authenticator.generateSecret();
const otpauth = otplib.authenticator.keyuri('username', 'app', sec);

qrcode.toDataURL(otpauth, (err, img) => {
    if(err) throw err
    console.log(image);
});
```
### Validate TOTP
```js
const valid = otplib.authenticator.check(userCode, sec);
if(valid) {console.log('Valid')}
else {console.log('Invalid')};
```

# Security Practice Tips
**Secure Storage of Keys**, store shared secrets securely, encrypted in a database, avoid plantext secrets.

**Syncronization**, make sure server time is syncchronized

**Rate Limiting**, limit the numbers of incrorrect attempts to prevent attacks.

**Backup Code**, if something happends, provide users with backup codes for account recovery.

## TOTP implementation in frameworks
```js
const express = require('express');
const otplib = require('otplib');
const bodyParser = require('body-parser');

const app = express();
app.use(bodyParser.json());

const users = {};

app.post('/generate', (req, res) => {
    const username = req.body.username;
    const secret = otplib.authenticator.generateSecret();
    users[username] = { secret };
    res.json({secret, qrCode: otplib.authenticator.keyuri(username, 'app', secret)});
});
app.post('/verify', (req, res) => {
    const { username, code } = req.body;
    const user = users[username];
    if(!user) {return res.status(404).send('Not Found')};
    const valid = otplib.authenticator.check(code, user.secret);
    res.json({sucess: valid});
    // tue or false
})
app.listen(3000);
```

**OTPlib Documentation for further learning and understanding**
[OTPlib Documentation](https://github.com/yeojz/otplib)